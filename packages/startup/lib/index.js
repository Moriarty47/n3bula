import k from"node:os";import{readFileSync as x}from"node:fs";import l from"node:path";import P from"node:http";import C from"node:https";import{fileURLToPath as R}from"node:url";import A from"connect";import O from"serve-static";import U from"serve-index";import E from"connect-history-api-fallback";import I from"open";import m from"debug";m.enable("startup");var v=m("startup"),a=v;import $ from"minimist";var u=8e3,n="      ",d=$(process.argv.slice(2),{alias:{open:"o",port:"p",name:"n",help:"h",root:"r",proxy:"x",log:"l",fallback:"f"},string:["port","name","open","fallback"],boolean:["log"],default:{port:u,root:process.cwd()}});d.help&&(["\x1B[32mUsage:\x1B[0m",`${n}startup -h/--help # Show help information`,`${n}startup # ${u} as default port, current folder as root`,`${n}startup [-p/--port] [port] # Running at specified port`,`${n}startup -o/--open [browser=chrome,msedge,firefox,brave] # Open url with specified browser`,`${n}startup -n/--name [hostname] # Running at specified hostname`,`${n}startup -r/--root [root] # Specified root`,`${n}startup -l/--log # Show log info`,`${n}startup -f/--fallback # Enable history fallback`,`${n}startup -x/--proxy [proxy_url] # Specified proxy url`].forEach(t=>{console.log(t.replace(/#(.*)$/,e=>`\x1B[90;3m${e}\x1B[0m`))}),process.exit(0));var o=d;import S from"node:path";import g from"http-proxy-middleware";var h=async(r,t)=>{if(r.proxy)try{t.use(g.createProxyMiddleware({changeOrigin:!0,target:new URL(r.proxy)}))}catch{await w(r,t)}};async function w(r,t){let e=await import(S.resolve(r.root,r.proxy));try{e=e.devServer.proxy}catch(c){r.log&&a(c)}Object.values(e).forEach(c=>{t.use(g.createProxyMiddleware(c))})}var y=l.dirname(R(import.meta.url)),j=r=>I(r,o.open?{app:{name:o.open}}:void 0),T=()=>{let r=k.networkInterfaces(),t=[];return Object.values(r).forEach(e=>{e&&e.forEach(i=>{i.internal||i.family!=="IPv4"||t.push(i.address)})}),t.sort(e=>e.indexOf("192")>=0?-1:1),t[0]||"127.0.0.1"},s=A();s.use((r,t,e)=>{t.setHeader("Access-Control-Allow-Origin","*"),o.log&&a(`${r.method} ${r.url}`),e()});o.fallback!==void 0&&(console.log("Enable html5 history mode."),s.use(E({index:o.fallback||"./index.html"})));await h(o,s);s.use(O(o.root,{index:["index.html"]}));s.use(U(o.root,{icons:!0}));var p=parseInt(o._[0]||o.port,10),f=p+1,b=o.name||T();P.createServer(s).listen(p,()=>{let r=`http://${b}${p!==80?`:${p}`:""}/`;console.log(`Running at ${r}`),o.o!==void 0&&j(r)});var _={key:x(l.join(y,"../certs","key.pem")),cert:x(l.join(y,"../certs","cert.pem"))};C.createServer(_,s).listen(f,()=>{let r=`https://${b}${f!==80?`:${f}`:""}/`;console.log(`Also running at ${r}`)});
